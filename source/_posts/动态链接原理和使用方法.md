---
title: 动态链接原理和使用方法
date: 2019-01-21 20:09:46
categories:
tags:
    - 动态链接
    - Java
cover_picture:
---
<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=default"></script> -->


本文介绍动态链接的原理以及在各个平台上创建和使用动态链接库的方法. 附带地, 本文也会涉及静态库的原理以及如何创建和使用静态库.



静态连接与动态链接
--------------------

静态库实际上是一组二进制的代码, 在编译的时候, 我们引用的静态库函数会直接复制到我们的程序之中. 动态库也是一组二进制代码, 但是编译的时候我们的程序并不包含相关的代码, 而是在运行的时候动态的去获得需要的代码.



Linux下的创建方法
-------------------

Linux平台下可以使用gcc创建静态库和动态库. 创建两种库都只需要设置不同的编译参数, 对于源代码不需要做任何的调整, 因此相比于在Windows平台编译, 相对来说更加简洁.

在Linux平台上, 静态库以`.a`结尾, 而动态库以`.so`结尾. 需要将一个文件编译为静态库时, 只需要执行

```
gcc -c stack/stack.c stack/push.c stack/pop.c stack/is_empty.c
ar rs libstack.a stack.o push.o pop.o is_empty.o 
```

按照约定, 静态库应该以`lib`开头, 以`.a`结尾, 使用`ar`指令将`.o`文件压缩为对应的静态库文件.  

当需要使用静态库时, 使用如下的参数指定

```
gcc main.c -L. -lstack -Istack -o main
```

其中`-L.`表示除了去规定的目录寻找库文件以外, 还需要在当前路径寻找库文件. `-lstack`表示需要连接`libstack.a`文件. 


- [linux下 GCC编译链接静态库&动态库](https://www.cnblogs.com/thechosenone95/p/10605172.html)
- [File format differences between a static library (.a) and a shared library (.so)?](https://stackoverflow.com/questions/41879433/file-format-differences-between-a-static-library-a-and-a-shared-library-so)


Windows下的创建方法
-------------------------

在Windows下, 对于静态库, 通常只需要发布一个`.lib`文件. 其中就包含了全部的代码. 而对于动态库, 则需要同时发布`.lib`文件和`.dll`文件. 其中`.lib`文件仅包含一些链接的信息, 仅在程序的链接阶段使用. 而`.dll`文件包含实际的代码, 在程序运行的时候使用.

如果使用Visual Studio进行开发, VS在创建Win32项目时, 可以直接选择创建DLL或者静态库. 选择相应的项目后直接编译就可以产生相应的库文件.

其中的一些细节可以参考一下的文章

- [手把手教你如何制作和使用lib和dll - CSDN](https://blog.csdn.net/sj2050/article/details/81700183)
- [DLLs in Visual C++ -Microsoft Docs](https://docs.microsoft.com/en-us/cpp/build/dlls-in-visual-cpp?view=vs-2017)



Java调用C++
--------------

本节介绍如何通过Java调用C++编译出来的DLL. 步骤如下:

1. 创建Java类, 使用native关键字声明相关的函数
2. 编译Java文件, 产生class文件
3. 使用JDK中的javah工具指定相应的class文件来产生需要的头文件
4. 使用VS创建DLL项目, 引入第三步产生的头文件,并且导入JDK中的jni.h和jni_md.h
5. 根据头文件实现相应的函数, 然后编译C++程序, 产生相应的DLL
6. 将编译产生的DLL放置到PATH变量包含的路径之中
7. Java中使用loadLibrary加载DLL

更细致的步骤可以参考以下的内容
- [Java调用C++动态链接库dll -成都汇智动力](http://m.sohu.com/a/246320140_100181197)